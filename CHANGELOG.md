# 变更日志

## 2024年更新

### 功能改进

#### 1. 鼠标悬浮说明
- **域名管理**：为所有操作按钮添加了tooltip提示
  - 查看详情按钮：显示"查看详情"
  - 编辑域名按钮：显示"编辑域名"  
  - 立即检查按钮：显示"立即检查"

- **代理管理**：为所有操作按钮添加了tooltip提示
  - 查看详情按钮：显示"查看详情"
  - 编辑代理按钮：显示"编辑代理"
  - 测试连接按钮：显示"测试连接"
  - 启用/禁用按钮：动态显示"启用"或"禁用"
  - 删除代理按钮：显示"删除代理"

- **URL监控**：为所有操作按钮添加了tooltip提示
  - 查看详情按钮：显示"查看详情"
  - 编辑监控按钮：显示"编辑监控"
  - 启用/禁用按钮：动态显示"启用"或"禁用"
  - 删除监控按钮：显示"删除监控"

#### 2. 代理测试功能修复
- 修复了代理测试功能中的SOCKS代理支持问题
- 简化了代理配置逻辑，使用代理模型的`proxy_dict`方法
- 移除了冗余的ImportError检查代码

#### 3. SOCKS代理支持
- 添加了SOCKS代理支持所需的依赖包：
  - `requests[socks]==2.31.0`
  - `PySocks==1.7.1`
- 修复了代理模型中的SOCKS代理URL格式
- 支持SOCKS4和SOCKS5代理类型
- 修复了URL监控使用SOCKS代理时的"Missing dependencies for SOCKS support"错误

#### 4. 代理测试UI交互优化
- **按钮状态管理**：
  - 测试过程中按钮变为禁用状态，防止重复点击
  - 按钮图标切换为加载动画，提供视觉反馈
  - 测试完成后自动恢复按钮状态

- **实时状态更新**：
  - 测试结果实时更新到表格中的状态、响应时间和最后检查时间
  - 状态变化时添加动画效果，提升用户体验
  - 成功状态徽章添加脉冲动画效果

- **增强的通知系统**：
  - 重新设计Toast通知，支持进度显示和详细结果展示
  - 成功/失败结果使用不同的渐变背景色
  - 显示详细的测试信息（响应时间、IP地址等）
  - 通知显示时间延长至5秒，提供更好的阅读体验

- **视觉优化**：
  - 添加CSS动画和过渡效果
  - 表格行悬停效果
  - 状态徽章动画效果
  - 现代化的渐变色彩设计

#### 5. URL监控检查功能
- **立即检查按钮**：
  - 为每个URL监控添加了"立即检查"按钮
  - 按钮具有加载状态指示和防重复点击保护
  - 支持鼠标悬浮提示"立即检查"

- **实时检查结果**：
  - 检查过程中显示进度状态和加载动画
  - 检查完成后显示详细结果（响应时间、状态码、响应大小）
  - 成功/失败结果使用不同的渐变背景色

- **状态实时更新**：
  - 检查结果立即更新到表格中的状态、响应时间和最后检查时间
  - 状态变化时添加缩放动画效果
  - 成功状态徽章添加脉冲动画效果

- **后端API优化**：
  - 修改URL检查路由返回JSON格式结果
  - 支持同步检查并返回详细检查信息
  - 包含响应时间、状态码、响应大小等详细信息

#### 6. 仪表盘修复
- **异常URL监控统计修复**：
  - 修复了仪表盘中异常URL监控统计逻辑错误
  - 原来统计的是过去24小时内失败的检查次数，现在统计当前状态为异常的活跃URL监控数量
  - 确保统计数据的准确性和实时性

- **今日检查功能移除**：
  - 移除了仪表盘中的"今日检查"统计功能
  - 简化了异常URL监控卡片的显示信息
  - 将显示文本改为"活跃监控中"，更准确地反映统计内容

- **URL监控卡片优化**：
  - 将"总URL监控数"改为"总URL监控"，显示所有URL监控数量
  - 统计逻辑改为显示总URL监控数，包括活跃和非活跃的监控

- **即将到期卡片标题优化**：
  - 将"即将到期域名"改为"即将到期"，使标题更简洁
  - 保持了原有的统计逻辑和显示内容

- **异常URL卡片标题优化**：
  - 将"异常URL监控"改为"异常URL"，使标题更简洁
  - 保持了原有的统计逻辑和显示内容

- **仪表盘卡片位置调整**：
  - 将"即将到期"和"总URL监控"两个卡片的位置对调
  - 调整后的顺序为：总域名数 → 即将到期 → 总URL监控 → 异常URL
  - 优化了仪表盘的视觉布局和逻辑顺序

#### 7. URL监控可用性进度条优化
- **10格进度条设计**：
  - 将原来的单一进度条改为10格进度条
  - 每格代表最近10次检查中的一次检查结果
  - 成功检查显示绿色，失败检查显示红色，无数据显示灰色

- **交互式体验**：
  - 鼠标悬浮在每格上显示详细的检查信息（成功/失败 + 检查时间）
  - 进度条具有悬停动画效果，提升用户体验
  - 支持Bootstrap tooltip提示功能

- **数据统计优化**：
  - 基于最近10次检查计算可用性百分比
  - 显示总检查次数和成功次数
  - 更准确地反映URL的近期可用性状态

- **视觉设计改进**：
  - 使用渐变色彩设计，成功为绿色渐变，失败为红色渐变
  - 进度条高度适中，不影响表格整体布局
  - 百分比显示更加醒目，便于快速识别

#### 8. 表格表头融合设计优化
- **融合表头设计**：
  - 为域名管理、URL监控、代理管理三个页面的表格表头进行融合设计
  - 使用渐变背景色和动态光效，提升视觉吸引力
  - 添加图标和动画效果，增强用户体验

- **表头样式特性**：
  - 渐变背景：从蓝紫色到紫色的渐变效果
  - 动态光效：表头具有流动的光效动画
  - 悬停效果：鼠标悬浮时表头会有轻微上移和背景变化
  - 图标装饰：每个表头都配有相应的Font Awesome图标

- **表格容器优化**：
  - 圆角设计：表格容器采用圆角设计，更加现代化
  - 阴影效果：添加柔和的阴影，增强层次感
  - 悬停动画：表格行悬停时有缩放和背景变化效果
  - 响应式设计：保持在不同屏幕尺寸下的良好显示效果

- **视觉一致性**：
  - 统一的设计语言：三个页面使用相同的表头样式
  - 色彩协调：表头颜色与整体界面色彩保持一致
  - 字体优化：使用更清晰的字体和字间距

#### 9. 表头文本舒展和搜索分页功能优化
- **表头文本舒展优化**：
  - 移除表头文本的大写转换，让文本更自然舒展
  - 调整字体大小从0.85rem增加到0.9rem，提升可读性
  - 增加表头内边距，让文本有更多呼吸空间
  - 设置最小宽度120px，确保表头内容不会过于拥挤
  - 文本左对齐，更符合中文阅读习惯

- **搜索功能实现**：
  - **域名管理**：支持按域名名称和描述搜索
  - **URL监控**：支持按监控名称、URL地址和描述搜索
  - **代理管理**：支持按代理名称、地址和描述搜索
  - 搜索框具有清除功能，方便用户重置搜索条件
  - 搜索条件与分页参数保持同步

- **分页功能实现**：
  - 支持每页显示10、20、50、100条记录
  - 分页组件包含上一页、下一页和页码导航
  - 显示当前页的记录范围和总记录数
  - 分页参数与搜索条件保持同步
  - 切换每页显示数量时自动重置到第一页

- **用户体验优化**：
  - 搜索和分页控制区域布局合理，不影响主要内容
  - 分页组件居中显示，视觉效果良好
  - 所有功能都支持URL参数，便于分享和书签
  - 响应式设计，在不同屏幕尺寸下都能正常使用

#### 10. 时区设置和URL监控进度条优化
- **北京时区设置**：
  - 添加了pytz依赖包，支持时区处理
  - 创建了时区工具模块`app/utils/timezone.py`
  - 配置文件中设置默认时区为北京时区（Asia/Shanghai）
  - 所有时间显示都使用北京时区，确保时间准确性

- **时区应用范围**：
  - **URL检查记录**：检查时间使用北京时区记录
  - **代理测试记录**：测试时间使用北京时区记录
  - **前端时间显示**：JavaScript中使用北京时区显示时间
  - **通知消息**：通知中的时间戳使用北京时区
  - **Webhook时间戳**：API调用中的时间戳使用北京时区

- **URL监控可用性进度条优化**：
  - **管道插入法显示**：最右侧显示最新的检查结果，最左侧显示无数据状态
  - **时间顺序优化**：从右到左按时间顺序显示检查记录，类似管道插入法
  - **数据填充逻辑**：最新的检查结果填充到最右侧位置，无数据位置显示在左侧
  - **视觉优化**：无数据状态使用斜纹背景和"—"符号，更加直观
  - **用户体验提升**：用户可以直观看到最新的检查状态和数据流向

- **技术实现细节**：
  - 修改了URL模型的`availability_progress_data`属性
  - 使用`len(recent_checks) - 1 - i`计算索引，实现从右到左填充
  - 保持了原有的10格进度条设计和交互功能
  - 时区转换使用pytz库，确保准确性
  - 优化了CSS样式，无数据状态使用斜纹背景和"—"符号
  - 简化了界面，移除了"最新"标签，保持界面简洁

#### 11. 表格滚动条UI优化和URL监控详情页异步检查
- **表格滚动条UI优化**：
  - 为所有表格添加了自定义滚动条样式
  - 滚动条使用渐变色彩设计，与整体界面风格一致
  - 支持WebKit和Firefox浏览器的滚动条样式
  - 滚动条具有悬停效果和圆角设计

- **URL监控可用性进度条响应式优化**：
  - 在常规屏幕下（≤1200px）隐藏进度条，只显示百分比
  - 百分比显示使用渐变背景色，更加美观
  - 添加了详细的tooltip提示，显示检查统计信息
  - 保持了在大屏幕下的完整进度条显示

- **URL监控详情页异步检查**：
  - 将详情页的立即检查改为异步操作，不再跳转页面
  - 添加了实时状态指示器和进度显示
  - 检查完成后显示详细结果（响应时间、状态码、响应大小）
  - 3秒后自动刷新页面，更新检查结果
  - 添加了错误处理和用户友好的提示信息

#### 12. 域名管理状态码显示和通知测试功能优化
- **域名管理官网可用性状态码显示**：
  - 在域名管理页面的官网可用性列中显示HTTP状态码
  - 当域名进行了访问检查时，显示最新的状态码信息
  - 状态码显示在可用性状态下方，使用小字体和灰色文本
  - 提供了更详细的域名访问状态信息

- **通知管理测试通知功能优化**：
  - **时区修复**：测试通知时间使用北京时区，确保时间显示正确
  - **消息格式优化**：使用更美观的消息格式，包含emoji和分隔线
  - **异步测试**：将测试通知改为异步操作，不再跳转页面
  - **实时反馈**：添加了测试状态指示器和进度显示
  - **详细结果**：显示测试结果和配置信息
  - **错误处理**：完善的错误处理和用户友好的提示信息
  - **UI优化**：测试按钮具有加载状态和防重复点击保护

#### 13. 域名管理异步刷新功能
- **域名管理列表页异步刷新**：
  - 添加了独立的"刷新WHOIS"和"刷新官网可用性"按钮
  - 按钮只在对应功能启用时显示（check_whois和check_access）
  - 使用异步操作，不跳转页面，提供实时反馈
  - 按钮具有加载状态指示和防重复点击保护

- **域名详情页异步刷新**：
  - 在详情页添加了相同的异步刷新功能
  - 替换了原有的同步WHOIS检查功能
  - 提供统一的用户体验和界面风格

- **异步刷新功能特性**：
  - **WHOIS刷新**：在后台线程中执行WHOIS查询，避免阻塞用户界面
  - **官网可用性刷新**：在后台线程中执行HTTPS访问检查
  - **实时状态反馈**：显示刷新进度和结果
  - **自动页面刷新**：刷新成功后3秒自动刷新页面显示最新结果
  - **错误处理**：完善的错误处理和用户友好的提示信息

- **技术实现**：
  - 新增两个API路由：`/domains/<id>/refresh_whois`和`/domains/<id>/refresh_access`
  - 使用threading模块在后台执行检查任务
  - 返回JSON格式的响应，支持前端异步处理
  - 统一的UI组件和CSS样式

#### 14. 域名管理页面功能修复
- **操作按钮交互修复**：
  - 修复了域名管理页面操作按钮点击不可用的问题
  - 修复了JavaScript代码结构问题，确保事件监听器正确绑定
  - 添加了完整的按钮状态管理和交互反馈

- **官网可用性状态码显示修复**：
  - 修复了官网可用性列中状态码不显示的问题
  - 修复了域名访问检查服务中的时区问题
  - 确保状态码正确保存和显示

- **技术修复**：
  - 修复了`DomainAccessChecker`中的时区设置问题
  - 统一使用北京时区进行时间记录
  - 优化了JavaScript代码结构，移除了调试代码

#### 15. 调度器冲突问题修复
- **调度器错误修复**：
  - 修复了官网可用性检查时的"Scheduler is already running"错误
  - 修复了WHOIS检查时的调度器冲突问题
  - 优化了后台线程中的服务调用方式

- **技术优化**：
  - 修改了`check_single_domain_access`和`check_single_whois`函数签名
  - 避免在后台线程中创建新的Flask应用实例
  - 直接传递domain对象而不是domain_id，减少数据库查询
  - 简化了`check_all_domain_access`和`check_all_whois`函数

- **性能提升**：
  - 减少了不必要的应用实例创建
  - 避免了调度器重复启动的问题
  - 提高了后台任务的执行效率

#### 16. 应用上下文问题修复
- **应用上下文错误修复**：
  - 修复了后台线程中"Working outside of application context"错误
  - 参考URL监控的实现方式，优化了异步检查的处理方式

- **技术优化**：
  - 修改了`check_single_domain_access`和`check_single_whois`函数，接受domain_id参数
  - 在函数内部使用`Domain.query.get(domain_id)`获取domain对象
  - 避免了在后台线程中创建新的应用实例
  - 使用现有的应用上下文，确保数据库操作正常

- **实现方式**：
  - 参考URL监控的`check_single_url(url_id)`实现模式
  - 在后台线程中传递ID而不是对象，避免应用上下文问题
  - 保持了与URL监控一致的代码结构和处理方式

#### 17. 后台线程应用上下文修复
- **应用上下文问题修复**：
  - 修复了后台线程中"Working outside of application context"错误的根本原因
  - 在后台线程中使用`current_app.app_context()`创建应用上下文

- **技术优化**：
  - 在后台线程中使用`from flask import current_app`
  - 使用`with current_app.app_context():`包装数据库操作
  - 避免了创建新的应用实例，防止调度器冲突
  - 确保后台线程中的数据库操作正常执行

- **实现方式**：
  - 在`perform_whois_check`和`perform_access_check`函数中添加应用上下文
  - 使用Flask的`current_app`而不是创建新的应用实例
  - 保持了与现有架构的一致性

#### 18. 调度器架构优化
- **调度器架构重新设计**：
  - 将调度器启动逻辑从`create_app`函数中分离出来
  - 确保调度器只在主线程中启动一次，避免冲突

- **技术优化**：
  - 简化`create_app`函数，移除调度器启动逻辑
  - 在`register_scheduled_jobs`函数中统一启动调度器
  - 独立的操作和计划任务完全分离，互不干扰
  - 后台线程可以安全创建应用实例，不会影响调度器

- **架构优势**：
  - 清晰的职责分离：应用创建 vs 调度器管理
  - 独立的操作（用户点击刷新）和计划任务（定时调度）完全独立
  - 避免了复杂的参数传递和条件判断
  - 更简洁、更可维护的代码结构

#### 19. 蓝图注册修复
- **关键修复**：
  - 修复了`create_app`函数中蓝图注册代码位置错误的问题
  - 蓝图注册代码被错误地放在了`return app`之后，导致所有路由404

- **技术修复**：
  - 将蓝图注册代码移到正确的位置（在`return app`之前）
  - 确保所有蓝图（dashboard、domains、urls、notifications、proxies、api）正确注册
  - 修复了域名管理、URL监控、代理管理等所有页面的路由问题

- **验证结果**：
  - ✅ 应用成功启动，所有路由正常工作
  - ✅ 域名管理页面可以正常访问（200状态码）
  - ✅ 异步刷新功能现在可以正常使用

#### 20. 调度器冲突最终修复
- **关键修复**：
  - 修复了后台线程中"Scheduler is already running"错误的根本原因
  - 后台线程中的`create_app()`调用仍然会初始化调度器，导致冲突

- **技术修复**：
  - 为`create_app`函数添加了`init_scheduler`参数（默认为True）
  - 在主线程中正常初始化调度器（`init_scheduler=True`）
  - 在后台线程中创建应用实例时不初始化调度器（`init_scheduler=False`）
  - 修改了域名管理的异步刷新函数，使用`create_app(init_scheduler=False)`

- **架构优势**：
  - 完全分离了主线程调度器和后台线程应用实例
  - 避免了调度器重复初始化的冲突
  - 保持了应用上下文的完整性
  - 后台线程可以安全执行数据库操作

- **验证结果**：
  - ✅ 应用成功启动，无调度器冲突错误
  - ✅ 异步刷新功能正常工作（WHOIS和官网可用性检查）
  - ✅ 所有页面正常访问，功能完整
  - ✅ 后台线程安全执行，无错误日志

#### 21. 项目架构梳理和文档完善

#### 22. 数据库文件创建逻辑修复
- **数据库路径处理优化**：
  - 修复了数据库文件路径不一致的问题
  - 添加了`get_actual_database_path()`函数，智能检测数据库文件位置
  - 支持从配置路径、Flask instance路径、当前目录等多个位置查找数据库文件
  - 确保数据库文件路径检查的准确性和可靠性

- **数据库管理脚本完善**：
  - 修复了`create_db.py`中的路径检查逻辑，正确显示数据库文件位置
  - 修复了`check_db.py`中的调度器冲突问题，使用`init_scheduler=False`
  - 修复了`manage_db.py`中的路径处理，支持完整的数据库管理功能
  - 统一了所有数据库脚本的路径处理逻辑

- **数据库连接优化**：
  - 修复了SQLAlchemy新版本中`db.engine.execute`弃用的问题
  - 使用`with db.engine.connect() as conn: conn.execute(db.text('SELECT 1'))`进行连接测试
  - 添加了数据库连接池配置，提升性能

- **数据库管理功能增强**：
  - 创建了完整的数据库管理工具`manage_db.py`
  - 支持数据库创建、检查、备份、恢复、优化等功能
  - 添加了详细的错误处理和状态反馈
  - 提供了友好的命令行界面和帮助信息

- **技术改进**：
  - 修复了表名不一致问题（`proxy` → `proxies`）
  - 添加了数据库完整性检查
  - 优化了错误信息显示，提供更详细的调试信息
  - 确保所有数据库操作都能正确处理Flask的instance_path
- **架构分析**：
  - 深入分析了当前项目架构的优点和不足
  - 识别了代码组织、错误处理、性能优化等方面的改进空间
  - 制定了详细的架构演进路线图

- **文档完善**：
  - **README.md**: 创建了详细的项目介绍文档，包含功能特性、架构说明、安装部署、使用指南等
  - **ARCHITECTURE_ANALYSIS.md**: 深入分析项目架构，提供优化建议和实施路线图
  - **DEPLOYMENT_GUIDE.md**: 详细的部署指南，包含开发环境、生产环境、Docker部署等

- **架构优化建议**：
  - **代码组织**: 建议拆分大型视图文件，实现更细粒度的模块化
  - **错误处理**: 统一异常处理机制，提供标准化的错误响应格式
  - **数据库优化**: 添加连接池配置，优化查询性能
  - **缓存机制**: 引入Redis缓存，提升系统性能
  - **API设计**: 统一API响应格式，实现版本控制
  - **日志系统**: 完善日志配置，实现结构化日志
  - **测试框架**: 建立完整的测试体系，提高代码质量
  - **性能监控**: 添加性能监控和慢查询检测

- **部署方案**：
  - **开发环境**: 简化的本地开发环境配置
  - **生产环境**: 完整的生产环境部署方案，包含Nginx、Gunicorn、Supervisor
  - **Docker部署**: 容器化部署方案，支持Docker Compose
  - **监控维护**: 健康检查、性能监控、日志管理、备份策略
  - **安全配置**: 防火墙、SSL证书、安全加固等

- **技术债务评估**：
  - 评估了当前技术债务状况
  - 制定了改进目标和优先级
  - 提供了风险评估和实施建议

- **项目价值**：
  - 提升了项目的可维护性和可扩展性
  - 为后续开发提供了清晰的指导方向
  - 完善了项目文档，便于团队协作和知识传承

### 技术改进

#### 1. 依赖管理
- 更新了`requirements.txt`文件，添加了SOCKS代理支持
- 确保所有依赖包版本兼容

#### 2. 前端优化
- 在`base.html`中添加了Bootstrap tooltip初始化代码
- 所有tooltip使用统一的样式和位置（顶部显示）
- 在`base.html`中添加了`extra_css`块支持，允许页面添加自定义样式
- 优化了代理测试界面的CSS动画和视觉效果

#### 3. 代码优化
- 简化了代理测试功能的代码结构
- 统一了代理配置的处理方式
- 改进了错误处理逻辑

### 验证结果

#### SOCKS代理支持测试
- ✅ PySocks包已正确安装
- ✅ requests[socks]包已正确安装  
- ✅ SOCKS5代理支持正常
- ✅ 应用成功启动并运行在5000端口

### 使用说明

1. **安装依赖**：
   ```bash
   pip install -r requirements.txt
   ```

2. **启动应用**：
   ```bash
   python run.py
   ```

3. **访问应用**：
   打开浏览器访问 `http://localhost:5000`

4. **使用新功能**：
   - 鼠标悬浮在任何操作按钮上查看提示信息
   - 在代理管理中测试SOCKS代理连接，享受优化的UI交互体验
   - 在URL监控中使用SOCKS代理进行监控
   - 观察代理测试的实时状态更新和动画效果
   - 在URL监控页面点击"立即检查"按钮进行实时URL检查
   - 查看URL检查的详细结果和实时状态更新

### 注意事项

- 确保代理服务器正常运行才能成功测试连接
- SOCKS代理需要正确的用户名和密码配置（如果代理服务器需要认证）
- 所有tooltip提示使用中文显示，符合用户界面语言要求
