{% extends "base.html" %}

{% block title %}添加域名 - 域名证书管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">添加域名</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('domains.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> 返回
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="domainForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">域名名称 *</label>
                        <input type="text" class="form-control" id="name" name="name" required 
                               placeholder="例如: example.com">
                        <div class="form-text">请输入域名，不包含协议前缀</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="添加域名描述信息"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check_whois" name="check_whois" checked>
                            <label class="form-check-label" for="check_whois">
                                启用WHOIS检查
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check_access" name="check_access">
                            <label class="form-check-label" for="check_access">
                                启用访问检查
                            </label>
                        </div>
                        <div class="form-text">检查域名的HTTPS可访问性，类似URL检查功能</div>
                    </div>
                    
                    <hr>
                    <h5>SSL证书信息</h5>
                    <div class="mb-3">
                        <label for="cert_file" class="form-label">证书公钥文件 (.crt/.pem)</label>
                        <input type="file" class="form-control" id="cert_file" name="cert_file" 
                               accept=".crt,.pem,.cer">
                        <div class="form-text">上传SSL证书公钥文件，系统将自动解析证书信息</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="key_file" class="form-label">私钥文件 (.key)</label>
                        <input type="file" class="form-control" id="key_file" name="key_file" 
                               accept=".key,.pem">
                        <div class="form-text">上传SSL证书私钥文件</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check_ssl" name="check_ssl">
                            <label class="form-check-label" for="check_ssl">
                                启用SSL证书检查
                            </label>
                        </div>
                    </div>
                    
                    <hr>
                    <h5>通知配置</h5>
                    <div class="mb-3">
                        <label for="notification_config_id" class="form-label">通知方式</label>
                        <select class="form-select" id="notification_config_id" name="notification_config_id">
                            <option value="">不发送通知</option>
                            {% for config in notification_configs %}
                            <option value="{{ config.id }}">{{ config.name }} ({{ config.type }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">选择检查异常时发送通知的方式</div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('domains.index') }}" class="btn btn-secondary me-md-2">取消</a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">添加域名</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">添加说明</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="fas fa-info-circle text-info"></i> 域名名称用于标识，建议使用主域名</li>
                    <li><i class="fas fa-search text-warning"></i> WHOIS检查会定期验证域名注册状态</li>
                    <li><i class="fas fa-globe text-primary"></i> 访问检查会验证域名的HTTPS可访问性</li>
                    <li><i class="fas fa-certificate text-primary"></i> 上传证书文件后系统自动解析信息</li>
                    <li><i class="fas fa-shield-alt text-success"></i> SSL检查会定期验证证书有效期</li>
                    <li><i class="fas fa-bell text-danger"></i> 配置通知后异常情况会及时提醒</li>
                </ul>
            </div>
        </div>
        
        <!-- WHOIS查询状态 -->
        <div class="card mt-3" id="whoisStatusCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">WHOIS查询状态</h5>
            </div>
            <div class="card-body">
                <div id="whoisStatusContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <p class="mt-2 mb-0">正在查询WHOIS信息...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 访问检查状态 -->
        <div class="card mt-3" id="accessStatusCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">访问检查状态</h5>
            </div>
            <div class="card-body">
                <div id="accessStatusContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <p class="mt-2 mb-0">正在检查域名访问性...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 文件上传时自动启用SSL检查
document.getElementById('cert_file').addEventListener('change', function() {
    if (this.files.length > 0) {
        document.getElementById('check_ssl').checked = true;
    }
});

// 表单提交处理
document.getElementById('domainForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const whoisStatusCard = document.getElementById('whoisStatusCard');
    const accessStatusCard = document.getElementById('accessStatusCard');
    const whoisCheckbox = document.getElementById('check_whois');
    const accessCheckbox = document.getElementById('check_access');
    
    // 如果启用了WHOIS检查，显示查询状态
    if (whoisCheckbox.checked) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 添加中...';
        whoisStatusCard.style.display = 'block';
    }
    
    // 如果启用了访问检查，显示检查状态
    if (accessCheckbox.checked) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 添加中...';
        accessStatusCard.style.display = 'block';
    }
    
    // 模拟状态更新
    setTimeout(() => {
        if (whoisCheckbox.checked) {
            const whoisStatusContent = document.getElementById('whoisStatusContent');
            whoisStatusContent.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-check-circle text-success"></i>
                    <p class="mt-2 mb-0">域名添加成功！</p>
                    <small class="text-muted">WHOIS查询将在后台进行</small>
                </div>
            `;
        }
        
        if (accessCheckbox.checked) {
            const accessStatusContent = document.getElementById('accessStatusContent');
            accessStatusContent.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-check-circle text-success"></i>
                    <p class="mt-2 mb-0">域名添加成功！</p>
                    <small class="text-muted">访问检查将在后台进行</small>
                </div>
            `;
        }
    }, 2000);
});
</script>
{% endblock %}
